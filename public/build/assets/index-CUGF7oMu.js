import{r as l,j as e,H as R}from"./app-DvaQrBj5.js";import{A as O}from"./app-layout-DQF4_mQx.js";import{e as o}from"./echo-ChpTs6qc.js";/* empty css            */import"./app-sidebar-layout-Sqm8IYV1.js";import"./app-logo-icon-D94uS_gU.js";import"./index-CySXUBmE.js";import"./index-Bc-c5Ken.js";import"./index-C4J_hXM0.js";import"./index-Bo-m__MM.js";const U=({user_id:d,other_user_id:c,users:w,chats:z})=>{const[j,v]=l.useState(z||[]),[h,N]=l.useState(""),[D,f]=l.useState("init"),p=()=>o.connector?.pusher,k=l.useRef(null),[S,E]=l.useState(""),[T,g]=l.useState([]),[$,C]=l.useState(!1),b=l.useRef(null);l.useEffect(()=>{const t=p()?.connection;if(f(t?.state||"connecting"),t){const a=n=>f(n.current||t.state);return t.bind("state_change",a),()=>t.unbind("state_change",a)}},[]),l.useEffect(()=>{let t=!1,a=null,n=null,r=null;return(async()=>{let u=0;for(;!window.Echo&&u<20;)await new Promise(s=>setTimeout(s,100)),u++;if(!t){if(!window.Echo){console.error("[Echo] nadal brak instancji po oczekiwaniu");return}r=`private-chat.${d}`,f(p()?.connection?.state||"connecting"),a=o.private(`chat.${d}`).listen("MessageSent",s=>{v(i=>i.some(x=>x.id===s.chatMessage.id)?i:[...i,s.chatMessage])}).listenForWhisper("typing",s=>{s.user_id===c&&(C(!0),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>C(!1),2e3))});try{n=o.join("chat").here(s=>{g(s.map(i=>i.id))}).joining(s=>{g(i=>i.includes(s.id)?i:[...i,s.id])}).leaving(s=>{g(i=>i.filter(x=>x!==s.id))})}catch(s){console.warn("Presence join error",s)}try{const s=p()?.connection;if(s){const i=x=>f(x.current||s.state);return s.bind("state_change",i),()=>{a&&a.stopListening("MessageSent"),r&&o.leaveChannel(r),n&&o.leave("chat"),s.unbind("state_change",i)}}}catch{}return()=>{a&&a.stopListening("MessageSent"),r&&o.leaveChannel(r),n&&o.leave("chat")}}})(),()=>{t=!0,a&&a.stopListening("MessageSent"),r&&o.leaveChannel(r),n&&o.leave("chat")}},[d]);const M=l.useCallback(async t=>{if(t.preventDefault(),!(!h.trim()||!c))try{const a=document.querySelector('meta[name="csrf-token"]')?.content;if(!a)return;const n=window.Echo?.socketId?.()||"",r=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":a||"","X-Socket-ID":n},credentials:"same-origin",body:JSON.stringify({other_user_id:c,message:h.trim()})});if(r.ok){const m=await r.json();v(u=>u.some(i=>i.id===m.id)?u:[...u,m]),N("")}}catch(a){console.error("Error sending message:",a)}},[h,c]),I=l.useCallback(t=>{if(N(t.target.value),c&&t.target.value.trim())try{const a=o.private?.(`chat.${c}`);a?.whisper&&a.whisper("typing",{user_id:d})}catch{}},[c,d]),y=c?w.find(t=>t.id===c):null;l.useEffect(()=>{const t=setTimeout(()=>{k.current?.scrollIntoView({behavior:"smooth",block:"end"})},20);return()=>clearTimeout(t)},[j,c]);const L=[{title:"Strona główna",href:"/"},{title:"Chat",href:"/chat"}];return e.jsxs(O,{breadcrumbs:L,children:[e.jsx(R,{title:"Chat"}),e.jsxs("div",{className:"container mx-auto shadow-lg rounded-lg",children:[e.jsx("div",{className:"px-5 py-5 flex flex-wrap gap-4 items-center bg-white border-b-2",children:y?e.jsxs("div",{className:"text-sm text-blue-600",children:["Aktualnie rozmawiasz z ",e.jsx("span",{className:"font-semibold",children:y.name}),e.jsx("span",{className:"text-gray-400 ml-2",children:"(wydział: #Marketing)"})]}):e.jsx("div",{className:"text-sm text-gray-400",children:"Wybierz użytkownika aby rozpocząć rozmowę"})}),e.jsxs("div",{className:"flex flex-row justify-between bg-white",children:[e.jsxs("div",{className:"flex flex-col w-2/5 border-r-2 overflow-y-auto",children:[e.jsx("div",{className:"border-b-2 py-4 px-2",children:e.jsx("input",{type:"text",placeholder:"Szukaj użytkownika...",className:"py-2 px-3 border-2 border-gray-200 rounded-2xl w-full focus:outline-none focus:border-blue-400",value:S,onChange:t=>E(t.target.value)})}),(()=>{const t=S.trim().toLowerCase(),a=w.filter(n=>n.id!==d&&(!t||n.name.toLowerCase().includes(t)||n.email.toLowerCase().includes(t)));return a.length===0?e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"Brak wyników"}):a.map(n=>{const r=n.id===c,m=T.includes(n.id);return e.jsxs("button",{type:"button",className:`flex flex-row gap-3 text-left w-full py-3 px-3 items-center border-b hover:bg-gray-50 focus:outline-none ${r?"bg-blue-50 border-l-4 border-blue-400":""}`,onClick:()=>{window.location.href=`/chat?other_user_id=${n.id}`},children:[e.jsx("img",{src:`https://i.pravatar.cc/150?u=${n.id}`,className:"object-cover h-12 w-12 rounded-full",alt:n.name}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:n.name}),e.jsx("span",{className:"text-xs text-gray-500",children:n.email})]}),e.jsx("span",{className:`ml-auto w-3 h-3 rounded-full ${m?"bg-green-500":"bg-red-400"} shadow-inner`,title:m?"Online":"Offline"})]},n.id)})})()]}),e.jsxs("div",{className:"w-full flex flex-col h-[calc(100vh-200px)]",children:[e.jsxs("div",{className:"flex-1 px-5 mt-5 space-y-3 overflow-y-auto pr-2 pb-[10vh]",children:[j.map(t=>{const a=t.sender_id===d;return e.jsxs("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:[!a&&e.jsx("img",{src:`https://i.pravatar.cc/100?u=${t.sender_id}`,className:"object-cover h-8 w-8 rounded-full mr-2",alt:"avatar"}),e.jsxs("div",{className:`px-4 py-2 rounded-2xl text-sm shadow max-w-[60%] break-words ${a?"bg-blue-500 text-white rounded-br-none":"bg-gray-200 text-gray-800 rounded-bl-none"}`,children:[t.message,e.jsx("div",{className:"mt-1 text-[10px] opacity-70 text-right",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),a&&e.jsx("img",{src:`https://i.pravatar.cc/100?u=${t.sender_id}`,className:"object-cover h-8 w-8 rounded-full ml-2",alt:"avatar"})]},t.id)}),$&&y&&e.jsxs("div",{className:"flex justify-start",children:[e.jsx("img",{src:`https://i.pravatar.cc/100?u=${c}`,className:"object-cover h-8 w-8 rounded-full mr-2",alt:"avatar"}),e.jsx("div",{className:"px-4 py-2 rounded-2xl text-sm shadow bg-gray-200 text-gray-800 rounded-bl-none",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"animate-bounce",children:"."}),e.jsx("span",{className:"animate-bounce",style:{animationDelay:"0.2s"},children:"."}),e.jsx("span",{className:"animate-bounce",style:{animationDelay:"0.4s"},children:"."})]})})]}),e.jsx("div",{ref:k})]}),e.jsx("div",{className:"sticky bottom-0 bg-white border-t px-5 py-4 mt-[5vh]",children:e.jsx("form",{onSubmit:M,children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"w-full bg-gray-100 border border-gray-300 py-3 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400",type:"text",placeholder:c?"Napisz wiadomość...":"Wybierz użytkownika z listy po lewej",value:h,onChange:I,disabled:!c}),e.jsx("button",{type:"submit",disabled:!h.trim()||!c,className:"px-5 rounded-xl bg-blue-500 text-white font-medium disabled:opacity-40",children:"Wyślij"})]})})})]})]})]})]})};export{U as default};
